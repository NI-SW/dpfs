
// configure nvme over rdma
cd spdk 
./configure --with-rdma --with-fio=../fio 
// --with-shared


/*
  to build spdk 
  yum install -y gcc-c++ libaio-devel numactl-devel openssl-devel CUnit-devel libuuid-devel
*/

// nvme over tcp
// ports
# echo ipv4 > addr_adrfam
# echo tcp > addr_trtype
# echo 0.0.0.0 > addr_traddr
# echo 50658 > addr_trsvcid
// subsystems
# echo /dev/nvme0n2  > device_path
# echo 1 > enable


// nvme over rdma
modprobe nvme_fabrics
modprobe nvme_tcp
modprobe nvme_rdma
modprobe nvmet
modprobe nvmet_rdma
modprobe rdma_rxe
rdma link add rxe_0 type rxe netdev ens160

nvme discover -t rdma -a 192.168.34.12 -s 4420

// not must
modprobe nvme_core
modprobe irdma
modprobe rpcrdma
modprobe rdma_ucm
modprobe rdma_cm
modprobe rdma_rxe
modprobe vmw_pvrdma


nvme远程连接时注意防火墙问题

安装依赖：：
libnvme          \
libverto         \
nvme-cli         \
nvmetcli         \
libnvme-devel    \
librdmacm        \
rdma-core-devel  \
rdma-core        \
libverto-libev   \
libverto-devel   \
perftest-23*     \




./rpc.py nvmf_get_subsystems
[
  {
    "nqn": "nqn.2014-08.org.nvmexpress.discovery",
    "subtype": "Discovery",
    "listen_addresses": [],
    "allow_any_host": true,
    "hosts": []
  }
]


SPDK attach:

start up -> nvme_tgt
# 添加远程rdma控制器
# ./rpc.py bdev_nvme_attach_controller -b nvme1 -t rdma -a 192.168.34.12 -f ipv4 -s 4420 -n nvme-subsys


# 创建rdma传输通道
modprobe nvme_fabrics
modprobe nvme_tcp
modprobe nvme_rdma
modprobe nvmet
modprobe nvmet_rdma
modprobe rdma_rxe
rdma link add rxe_0 type rxe netdev ens160




# 添加本地pcie控制器
./rpc.py bdev_nvme_attach_controller -b nvme4 -t pcie -a 0000:1b:00.0

# 创建nvmf子系统
./rpc.py nvmf_create_subsystem nqn.2016-06.io.spdk:cnode1 -a -s SPDK00000000000001 -d SPDK_Controller1
# 添加 namespace
./rpc.py nvmf_subsystem_add_ns nqn.2016-06.io.spdk:cnode1 nvme4n1

# spdk nvme over rdma
./rpc.py nvmf_create_transport -t RDMA -u 8192 -i 32768 -c 8192
./rpc.py nvmf_subsystem_add_listener -t RDMA -a 192.168.34.12 -f ipv4 -s 50658  nqn.2016-06.io.spdk:cnode1


# spdk nvme over tcp
./rpc.py nvmf_create_transport -t TCP -u 8192 -i 32768 -c 8192
./rpc.py nvmf_subsystem_add_listener -t TCP -a 192.168.34.12 -f ipv4 -s 50659  nqn.2016-06.io.spdk:cnode1

# io_uring权限问题，查看
sysctl kernel.io_uring_disabled
# 如果输出不为0，则设置为0即可
